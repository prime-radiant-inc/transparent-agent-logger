<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Session {{.SessionID}} - LLM Proxy Explorer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/">LLM Proxy Explorer</a>
        <form action="/search" method="get">
            <input type="text" name="q" placeholder="Search logs...">
            <button type="submit">Search</button>
        </form>
    </nav>
    <main>
        <header class="session-header">
            <h2>Session: <code>{{.SessionID}}</code></h2>
            <span class="host">{{.Host}}</span>
        </header>

        {{range .Turns}}
        <div class="turn">
            <div class="turn-header">
                {{if .Response}}<span class="timestamp">{{.Response.Meta.Timestamp.Format "15:04:05.000"}}</span>{{else if .Request}}<span class="timestamp">{{.Request.Meta.Timestamp.Format "15:04:05.000"}}</span>{{end}}
                <span class="model">{{.ReqParsed.Model}}</span>
                <span class="seq">#{{.Seq}}</span>
                {{if .RequestID}}<span class="request-id">{{.RequestID}}</span>{{end}}
            </div>
            <!-- Request: User messages -->
            {{if .Request}}
            <div class="message user">
                <div class="meta">
                    <span class="role">User</span>
                </div>

                {{if .ReqParsed.System}}
                <details class="system-prompt">
                    <summary>System Prompt</summary>
                    <pre>{{.ReqParsed.System}}</pre>
                </details>
                {{end}}

                {{/* Show only the last user message - the new content for this turn */}}
                {{if .LastUserMessage}}
                <div class="content user-content">
                    {{range .LastUserMessage.Content}}
                        {{if eq .Type "text"}}
                        <pre class="text">{{.Text}}</pre>
                        {{else if eq .Type "tool_result"}}
                        <div class="tool-result">
                            <div class="tool-header">Tool Result ({{.ToolID}})</div>
                            <pre>{{.Text}}</pre>
                        </div>
                        {{end}}
                    {{end}}
                    {{/* Fallback for simple string content */}}
                    {{if and .LastUserMessage.TextContent (not .LastUserMessage.Content)}}
                        <pre class="text">{{.LastUserMessage.TextContent}}</pre>
                    {{end}}
                </div>
                {{end}}

                {{/* Collapsed section for conversation history if there are previous messages */}}
                {{if gt (len .ReqParsed.Messages) 1}}
                <details class="conversation-history">
                    <summary>Conversation History ({{len .ReqParsed.Messages}} messages)</summary>
                    <div class="history-content">
                        {{range .ReqParsed.Messages}}
                            {{if eq .Role "user"}}
                            <div class="history-message history-user">
                                <span class="history-role">User:</span>
                                {{range .Content}}
                                    {{if eq .Type "text"}}
                                    <pre class="text">{{.Text}}</pre>
                                    {{else if eq .Type "tool_result"}}
                                    <div class="tool-result">
                                        <div class="tool-header">Tool Result ({{.ToolID}})</div>
                                        <pre>{{.Text}}</pre>
                                    </div>
                                    {{end}}
                                {{end}}
                                {{if and .TextContent (not .Content)}}
                                    <pre class="text">{{.TextContent}}</pre>
                                {{end}}
                            </div>
                            {{else if eq .Role "assistant"}}
                            <div class="history-message history-assistant">
                                <span class="history-role">Assistant:</span>
                                {{range .Content}}
                                    {{if eq .Type "text"}}
                                    <pre class="text">{{.Text}}</pre>
                                    {{else if eq .Type "tool_use"}}
                                    <div class="tool-call">
                                        <div class="tool-header">{{.ToolName}}</div>
                                        <pre class="tool-input">{{printf "%v" .ToolInput}}</pre>
                                    </div>
                                    {{end}}
                                {{end}}
                            </div>
                            {{end}}
                        {{end}}
                    </div>
                </details>
                {{end}}

                <details>
                    <summary>Raw Request</summary>
                    <pre class="raw">{{.Request.Raw}}</pre>
                </details>
            </div>
            {{end}}

            <!-- Response: Assistant content -->
            {{if .Response}}
            <div class="message assistant">
                <div class="meta">
                    <span class="role">Assistant</span>
                    {{if .RespParsed.Usage.OutputTokens}}
                    <span class="tokens">{{.RespParsed.Usage.InputTokens}} in / {{.RespParsed.Usage.OutputTokens}} out</span>
                    {{end}}
                </div>

                {{range .RespParsed.Content}}
                    {{if eq .Type "thinking"}}
                    <details class="thinking-block">
                        <summary>Thinking...</summary>
                        <pre class="thinking">{{.Thinking}}</pre>
                    </details>
                    {{else if eq .Type "text"}}
                    <div class="content assistant-content">
                        <pre class="text">{{.Text}}</pre>
                    </div>
                    {{else if eq .Type "tool_use"}}
                    <div class="tool-call">
                        <div class="tool-header">{{.ToolName}}</div>
                        <pre class="tool-input">{{printf "%v" .ToolInput}}</pre>
                    </div>
                    {{end}}
                {{end}}

                <details>
                    <summary>Raw Response</summary>
                    <pre class="raw">{{.Response.Raw}}</pre>
                </details>
            </div>
            {{end}}
        </div>
        {{end}}
    </main>
</body>
</html>
